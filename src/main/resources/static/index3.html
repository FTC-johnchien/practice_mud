<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern MUD Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #00ff00;
            --danger-color: #ff4444;
            --mp-color: #4444ff;
            --border-color: #333;
            --btn-bg: #2a2a2a;
            --btn-active: #444;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; /* é˜²æ­¢æ•´å€‹é é¢æ²å‹• */
        }

        /* ä¸»å®¹å™¨ï¼šæ‰‹æ©Ÿæ¨¡å¼ä¸‹æ”¹ç‚ºå‚ç›´å †ç–Š */
        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-header {
            background: var(--sidebar-bg);
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .bar-container { height: 12px; background: #333; border-radius: 6px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background: var(--danger-color); }
        .mp-fill { background: var(--mp-color); }

        /* éŠæˆ² Log å€ */
        #log {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 16px; /* æ‰‹æ©Ÿç«¯å­—é«”ç¨å¤§ä¸€é» */
            line-height: 1.5;
            background: #000;
            white-space: pre-wrap;
        }

        /* æ‰‹æ©Ÿæ§åˆ¶é¢æ¿ */
        .mobile-panel {
            background: var(--sidebar-bg);
            display: grid;
            grid-template-columns: 1fr 1.2fr; /* å¿«æ·éµ vs æ–¹å‘éµ */
            padding: 10px;
            gap: 10px;
            border-top: 2px solid var(--border-color);
            user-select: none;
        }

        /* å¿«æ·æŒ‡ä»¤å€ */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        /* æ–¹å‘å°èˆªå€ (ä¹å®®æ ¼) */
        .direction-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        button {
            background: var(--btn-bg);
            color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 5px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§åæ‡‰é€Ÿåº¦ */
        }

        button:active {
            background: var(--btn-active);
            transform: scale(0.95);
        }

        .dir-btn { font-weight: bold; background: #333; font-size: 18px; }
        .center-btn { background: #442222; } /* é»ä¸­é–“åŸ·è¡Œ Look */

        /* è¼¸å…¥æ¡†å€ */
        .input-bar {
            display: flex;
            padding: 8px;
            background: #000;
        }

        input[type="text"] {
            flex: 1;
            background: #111;
            border: 1px solid var(--border-color);
            color: var(--accent-color);
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
        }

        /* æ¡Œæ©Ÿæ¨¡å¼ä¿®æ­£ */
        @media (min-width: 769px) {
            .mobile-panel { grid-template-columns: 1fr 300px; }
            .direction-pad { width: 200px; margin-left: auto; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div class="status-header">
        <div>
            <div style="font-size: 12px;">HP: <span id="hp-val">0/0</span></div>
            <div class="bar-container"><div id="hp-bar" class="bar-fill hp-fill" style="width: 0%"></div></div>
        </div>
        <div>
            <div style="font-size: 12px;">MP: <span id="mp-val">0/0</span></div>
            <div class="bar-container"><div id="mp-bar" class="bar-fill mp-fill" style="width: 0%"></div></div>
        </div>
    </div>

    <div id="log"></div>

    <div class="mobile-panel">
        <div class="quick-actions">
            <button onclick="send('sc')">ç‹€æ…‹</button>
            <button onclick="send('i')">ç‰©å“</button>
            <button onclick="send('get all')">å…¨æ’¿</button>
            <button onclick="send('skills')">æŠ€èƒ½</button>
            <button onclick="send('rest')">ä¼‘æ¯</button>
            <button onclick="send('sit')">åä¸‹</button>
        </div>

        <div class="direction-pad">
            <button class="dir-btn" onclick="send('nw')">â†–</button>
            <button class="dir-btn" onclick="send('n')">N</button>
            <button class="dir-btn" onclick="send('ne')">â†—</button>
            <button class="dir-btn" onclick="send('w')">W</button>
            <button class="dir-btn center-btn" onclick="send('l')">ğŸ‘ï¸</button>
            <button class="dir-btn" onclick="send('e')">E</button>
            <button class="dir-btn" onclick="send('sw')">â†™</button>
            <button class="dir-btn" onclick="send('s')">S</button>
            <button class="dir-btn" onclick="send('se')">â†˜</button>
        </div>
    </div>

    <div class="input-bar">
        <input type="text" id="cmd-input" placeholder="è¼¸å…¥æŒ‡ä»¤..." autocomplete="off" autofocus>
        <button onclick="handleEnter()" style="margin-left: 5px; padding: 0 15px;">ç™¼é€</button>
    </div>
</div>

<script>
    // 1. ä¿®æ­£åˆå§‹åŒ–åç¨± (ç¢ºä¿æ˜¯ AnsiUp)
    const ansi_up = new AnsiUp();
    ansi_up.use_classes = false;

    let ws = null;
    const logDiv = document.getElementById('log');
    const cmdInput = document.getElementById('cmd-input');

    function connect() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        // å»ºè­°æ¸¬è©¦æ™‚å…ˆè·Ÿ index2 ä¸€æ¨£å¯«æ­» localhost ç¢ºä¿è®Šæ•¸ä¸€è‡´
        const socketUrl = 'ws://localhost:8080/ws';

        console.log("æ­£åœ¨å˜—è©¦é€£ç·šè‡³:", socketUrl);
        appendLog("å˜—è©¦é€£ç·š: " + socketUrl, "#ffff00");

        ws = new WebSocket(socketUrl);

        ws.onopen = () => appendLog("ç³»çµ±ï¼šé€£ç·šæˆåŠŸï¼", "#00ff00");

        ws.onclose = () => {
            appendLog("ç³»çµ±ï¼šé€£ç·šä¸­æ–·ï¼Œ3ç§’å¾Œå˜—è©¦é‡é€£...", "#ff4444");
            setTimeout(connect, 3000);
        };

        ws.onmessage = (event) => {
            console.log("åŸå§‹è¨Šæ¯:", event.data); // é€™è£¡å¯ä»¥å¹«ä½ ç¢ºèªå¾Œç«¯åˆ°åº•å‚³ä»€éº¼
            try {
                const data = JSON.parse(event.data);

                // æ”¯æ´ index2.html çš„æ ¼å¼: ç›´æ¥æª¢æŸ¥ msg.content
                if (data.content) {
                    appendLog(data.content);
                }
                // æ”¯æ´ STAT_UPDATE æ ¼å¼
                else if (data.type === 'STAT_UPDATE' || data.type === 'stats') {
                    // ç›¸å®¹è™•ç†ï¼šindex2 ç”¨ STAT_UPDATE, index3 ç”¨ stats
                    const payload = data.payload || data;
                    updateStats(payload);
                }
            } catch (e) {
                // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥é¡¯ç¤ºç´”æ–‡å­—
                appendLog(event.data);
            }
        };
    }

    // ä¿®æ­£ send å‡½æ•¸ï¼šindex2 ä½¿ç”¨ JSON å°è£ï¼Œindex3 ä¹‹å‰å‚³ç´”æ–‡å­—
    // å¦‚æœä½ çš„ä¼ºæœå™¨éœ€è¦ JSON INPUTï¼Œé€™è£¡å¿…é ˆä¿®æ”¹
    function send(cmd) {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        // é…åˆå¾Œç«¯ index2 çš„æ ¼å¼ï¼Œå‚³é€ JSON ç‰©ä»¶
        const msg = JSON.stringify({ type: "INPUT", text: cmd });
        ws.send(msg);

        appendLog("> " + cmd, "#888");
    }

    function handleEnter() {
        const cmd = cmdInput.value.trim();
        if (cmd) {
            send(cmd);
            cmdInput.value = "";
            // cmdInput.blur(); // æ‰‹æ©Ÿç‰ˆå¯ä»¥è€ƒæ…®ä¿ç•™éµç›¤ï¼Œé€£çºŒè¼¸å…¥
        }
    }

    function updateStats(s) {
        // åŠ ä¸Šé˜²éŒ¯ï¼Œé¿å… s.hp æ˜¯ undefined
        if(s.hp !== undefined) {
            const hpMax = s.maxHp || 100;
            document.getElementById('hp-val').innerText = `${s.hp}/${hpMax}`;
            document.getElementById('hp-bar').style.width = (s.hp / hpMax * 100) + "%";
        }
        if(s.mp !== undefined) {
            const mpMax = s.maxMp || 100;
            document.getElementById('mp-val').innerText = `${s.mp}/${mpMax}`;
            document.getElementById('mp-bar').style.width = (s.mp / mpMax * 100) + "%";
        }
    }

    function appendLog(text, color) {
        if (!text) return;
        const div = document.createElement('div');
        if (color) div.style.color = color;

        // ä½¿ç”¨ ansi_up è™•ç†é¡è‰²
        div.innerHTML = ansi_up.ansi_to_html(text);
        logDiv.appendChild(div);

        logDiv.scrollTop = logDiv.scrollHeight;
        if (logDiv.childNodes.length > 200) logDiv.removeChild(logDiv.firstChild);
    }

    cmdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleEnter();
    });

    connect();
</script>

</body>
</html>