<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HTML MUD 測試客戶端</title>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #ccc; font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        /* 使用 pre-wrap 保留空白與換行，這對 MUD 排版很重要 */
        #output { flex-grow: 1; border: 1px solid #333; padding: 10px; overflow-y: auto; margin-bottom: 10px; white-space: pre-wrap; background: #000; font-size: 14px; line-height: 1.4; }
        #input-area { display: flex; gap: 10px; }
        input { background: #000; color: #00ff00; border: 1px solid #444; padding: 10px; flex-grow: 1; outline: none; font-family: inherit; }
        button { background: #006600; color: #fff; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        button:hover { background: #008800; }
        .status { color: #666; font-size: 0.8em; margin-bottom: 5px; }

        /* 讓 ansi_up 產生的 span 能夠正確顯示粗體 */
        span[style*="bold"] { font-weight: bold; }
    </style>
</head>
<body>
    <div class="status" id="status">狀態: 尚未連線</div>
    <div id="output"></div>
    <div id="input-area">
        <input type="text" id="commandInput" placeholder="輸入指令..." autofocus>
        <button onclick="sendCommand()">發送</button>
    </div>

    <script>
        let socket;
        // 2. 初始化 AnsiUp
        const ansi_up = new AnsiUp();
        // 設定不要轉義 HTML (因為我們相信後端的內容，且需要顯示顏色)
        // 或者設為 true 來防止 XSS，視您的需求而定
        ansi_up.use_classes = false;

        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const input = document.getElementById('commandInput');

        function connect() {
            // 連線至 WebSocket 端點
            socket = new WebSocket('ws://' + window.location.host + '/ws');

            socket.onopen = () => {
                status.innerText = '狀態: 已連線至 ' + window.location.host;
                appendLog('>>> 系統：已建立連線', '#888'); // 系統訊息用灰色
            };

            socket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'TEXT') {
                        // 3. 使用 ansi_up 將後端的 ANSI code 轉為 HTML
                        const html = ansi_up.ansi_to_html(msg.content);
                        appendHtml(html);
                    }
                } catch (e) {
                    console.error("解析訊息失敗:", event.data);
                }
            };

            socket.onclose = () => {
                status.innerText = '狀態: 連線已中斷';
                appendLog('>>> 系統：連線已關閉', '#ff5555');
            };

            socket.onerror = (error) => {
                appendLog('>>> 錯誤：WebSocket Error', '#ff5555');
            };
        }

        // 輔助函式：直接插入已轉換好的 HTML
        function appendHtml(htmlContent) {
            const div = document.createElement('div');
            // 注意：這裡直接塞入 HTML，確保 ansi_up 轉出來的 span tag 生效
            div.innerHTML = htmlContent;
            output.appendChild(div);
            scrollToBottom();
        }

        // 輔助函式：插入純文字 log (本機系統訊息用)
        function appendLog(text, color) {
            const div = document.createElement('div');
            div.textContent = text;
            if (color) div.style.color = color;
            output.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }

        function sendCommand() {
            const text = input.value.trim();
            if (text && socket.readyState === WebSocket.OPEN) {
                // 4. 【重要】需包裝成 JSON 信封發送，符合後端 GameCommand 結構
                const payload = JSON.stringify({
                    type: "INPUT",
                    text: text
                });

                socket.send(payload);

                // 在本地顯示自己輸入的指令 (模擬 echo，選用青色)
                // 這裡我們手動加一點顏色區分
                appendHtml('<span style="color:#00ffff">> ' + text + '</span>');

                input.value = '';
            }
        }

        // 監聽 Enter 鍵
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendCommand();
        });

        // 初始化連線
        connect();
    </script>
</body>
</html>